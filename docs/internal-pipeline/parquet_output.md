---
layout: default
---
\[[Front page](../index.md)\] \[[Internal data pipeline](../internal_data_pipeline.md)\]

# Format of received Kafka messages from `ccx-XXX-insights-operator-archive-features` topic

Parquet Factory is a program that can read data from several data sources,
aggregate the data received from them and generate a set of Parquet files with
the aggregated data, storing them in a S3 bucket. It is used to generate
different data aggregations in the CCX Internal Data Pipeline, reading data
from Kafka topics and Thanos service.

## Schema version

1 (unofficial)

## Description

Three types of Parquet files (tables) are generated by Parquet Factory service:

* `cluster_info`
* `rule_hits`
* `cluster_thanos_info`

Format of these tables are described below.

## Basic format

---
**NOTE**

byte array is used in Parquet files also to represent string (among other data
structures). For more information please look at
[https://parquet.apache.org/documentation/latest/](https://parquet.apache.org/documentation/latest/).

---

### Format of `cluster_info` table

* `cluster_id` (byte array) cluster ID represented as UUID
* `current_version` (byte array) cluster version represented as string
* `platform` (byte array) cluster platform specification
* `collected_at` (timestamp) timestamp of report represented with millisecond precision
* `desired_version` (byte array) desired cluster version represented as string
* `archive_path` (byte array) path to the object stored in Ceph


#### `cluster_id` attribute

`cluster_id` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens). For more information
please look at
[https://en.wikipedia.org/wiki/Universally_unique_identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier).

An example of UUID:

```
3ba9b042-b8b8-4714-98e9-17915c2eeb95
```

#### `current_version` attribute

Current cluster version represented as string, for example "4.5.24" or even
"4.6.0-0.ci.test-2020-12-01-123456-ci-xx-yyyyyyy"


#### `platform` attribute

Cluster platform specification, for example "BareMetal", "OpenStack", "Azure"
etc.


#### `collected_at` attribute

Timestamp of report represented with millisecond precision, for example
"2021-02-08 00:22:19" (this is the display format, the precision is higher
internally)


#### `desired_version` attribute

Desired cluster version represented as string, for example "4.5.24" or even
"4.6.0-0.ci.test-2020-12-01-123456-ci-xx-yyyyyyy"


#### `archive_path` attribute

This attribute contains path to object stored in Ceph. It must be real path
with chunks splitted by slash character. The format of path is:

```
archives/compressed/{PREFIX}/{CLUSTER_ID}/{YEAR+MONTH}/{DAY}/{ID}.tar.gz |
```

An example of path:

```
archives/compressed/0a/0aaaaaaa-bbbb-cccc-dddd-ffffffffffff/202102/08/003201.tar.gz |
```


### Format of `rule_hits` table

* `cluster_id` (byte array) cluster ID represented as UUID
* `rule_id` (byte array)
* `collected_at` (timestamp) timestamp of report represented in milliseconds
* `archive_path` (byte array) path to the object stored in Ceph


#### `cluster_id` attribute

`cluster_id` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens). For more information
please look at
[https://en.wikipedia.org/wiki/Universally_unique_identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier).

An example of UUID:

```
3ba9b042-b8b8-4714-98e9-17915c2eeb95
```

#### `rule_id` attribute

It contains rule name and a key that are joined by | character.

Example of rule IDs:

```
pods_check_containers|POD_CONTAINER_ISSUE
operators_check|OPERATOR_ISSUE
pods_check|POD_ISSUE
```

#### `collected_at` attribute

Timestamp of report represented with millisecond precision, for example
"2021-02-08 00:22:19" (this is the display format, the precision is higher
internally)


#### `archive_path` attribute

This attribute contains path to object stored in Ceph. It must be real path
with chunks splitted by slash character. The format of path is:

```
archives/compressed/{PREFIX}/{CLUSTER_ID}/{YEAR+MONTH}/{DAY}/{ID}.tar.gz |
```

An example of path:

```
archives/compressed/0a/0aaaaaaa-bbbb-cccc-dddd-ffffffffffff/202102/08/003201.tar.gz |
```


### Format of `cluster_thanos_info` table

* `cluster_id` (byte array) cluster ID represented as UUID
* `ebs_account` (byte array) account number
* `email_domain` (byte array) an e-mail domain
* `managed` (bool) flag whether the cluster is managed or not
* `collected_at` (timestamp) timestamp of report represented with millisecond precision


#### `cluster_id` attribute

`cluster_id` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens). For more information
please look at
[https://en.wikipedia.org/wiki/Universally_unique_identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier).

An example of UUID:

```
3ba9b042-b8b8-4714-98e9-17915c2eeb95
```

#### `ebs_account` attribute

Account number, which is usually a positive integer represented as string, for
example "123456".

#### `email_domain` attribute

An e-mail domain, for example: "redhat.com"

#### `managed` (bool) attribute

Boolean flag containing info if the cluster is managed or not.

#### `collected_at` attribute

Timestamp of report represented with millisecond precision, for example
"2021-02-08 00:22:19" (this is the display format, the precision is higher
internally)


## Possible enhancements

* Version (positive integer) should be included in the generated Parquet files
  into separate column.
* For strings with fixed (and known) length, fixed_len_byte_array type should
  be used to speedup Parquet file generation and consuming.
* Using dictionaries for `cluster_id` might not be optimal - more study needed.

## Examples

### Content of `cluster_info` table

```
+--------------------------------------+-------------------------------------------------+-----------+---------------------+-------------------------------------------------+-------------------------------------------------------------------------------------+
| cluster_id                           | cluster_version                                 | platform  | collected_at        | desired_version                                 | archive_path                                                                        |
|--------------------------------------+-------------------------------------------------+-----------+---------------------+-------------------------------------------------+-------------------------------------------------------------------------------------|
| 00000000-0000-0000-0000-000000000000 | 4.5.24                                          | None      | 2021-02-08 00:22:19 | 4.5.24                                          | archives/compressed/00/00000000-0000-0000-0000-000000000000/202102/08/002219.tar.gz |
| 11111111-1111-1111-1111-111111111111 | 4.4.10                                          | Azure     | 2021-02-08 00:25:46 | 4.4.10                                          | archives/compressed/11/11111111-1111-1111-1111-111111111111/202102/08/002546.tar.gz |
| 22222222-2222-2222-2222-222222222222 | 4.5.19                                          | VSphere   | 2021-02-08 00:10:16 | 4.5.19                                          | archives/compressed/22/22222222-2222-2222-2222-222222222222/202102/08/001016.tar.gz |
| 33333333-3333-3333-3333-333333333333 | 4.3.13                                          | None      | 2021-02-08 00:10:08 | 4.3.13                                          | archives/compressed/33/33333333-3333-3333-3333-333333333333/202102/08/001008.tar.gz |
| 44444444-4444-4444-4444-444444444444 | 4.4.30                                          | Azure     | 2021-02-08 00:14:39 | 4.4.30                                          | archives/compressed/44/44444444-4444-4444-4444-444444444444/202102/08/001439.tar.gz |
| 55555555-5555-5555-5555-555555555555 | 4.6.9                                           | VSphere   | 2021-02-08 00:06:36 | 4.6.9                                           | archives/compressed/55/55555555-5555-5555-5555-555555555555/202102/08/000636.tar.gz |
| 66666666-6666-6666-6666-666666666666 | 4.6.13                                          | AWS       | 2021-02-08 00:22:39 | 4.6.13                                          | archives/compressed/66/66666666-6666-6666-6666-666666666666/202102/08/002239.tar.gz |
| 77777777-7777-7777-7777-777777777777 | 4.6.0-0.ci.test-2020-12-01-142302-ci-ln-cq06sq2 | OpenStack | 2021-02-08 00:24:34 | 4.6.0-0.ci.test-2020-12-01-142302-ci-ln-cq06sq2 | archives/compressed/77/77777777-7777-7777-7777-777777777777/202102/08/002434.tar.gz |
| 88888888-8888-8888-8888-888888888888 | 4.6.13                                          | BareMetal | 2021-02-08 00:06:33 | 4.6.13                                          | archives/compressed/88/88888888-8888-8888-8888-888888888888/202102/08/000633.tar.gz |
| 99999999-9999-9999-9999-999999999999 | 4.6.12                                          | VSphere   | 2021-02-08 00:28:51 | 4.6.12                                          | archives/compressed/99/99999999-9999-9999-9999-999999999999/202102/08/002851.tar.gz |
| aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa | 4.6.15                                          | VSphere   | 2021-02-08 00:32:01 | 4.6.15                                          | archives/compressed/aa/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa/202102/08/003201.tar.gz |
+--------------------------------------+-------------------------------------------------+-----------+---------------------+-------------------------------------------------+-------------------------------------------------------------------------------------+
```

---
**NOTE**

`cluster_id` is mocked, these clusters are not real.

---

### Content of `rule_hits` table

```
+--------------------------------------+-------------------------------------------+---------------------+-------------------------------------------------------------------------------------+
| cluster_id                           | rule_id                                   | collected_at        | archive_path                                                                        |
|--------------------------------------+-------------------------------------------+---------------------+-------------------------------------------------------------------------------------|
| 00000000-0000-0000-0000-000000000000 | pods_check_containers|POD_CONTAINER_ISSUE | 2021-02-08 00:59:34 | archives/compressed/00/00000000-0000-0000-0000-000000000000/202102/08/005934.tar.gz |
| 11111111-1111-1111-1111-111111111111 | operators_check|OPERATOR_ISSUE            | 2021-02-08 00:59:34 | archives/compressed/11/11111111-1111-1111-1111-111111111111/202102/08/005934.tar.gz |
| 22222222-2222-2222-2222-222222222222 | pods_check|POD_ISSUE                      | 2021-02-08 00:59:34 | archives/compressed/22/22222222-2222-2222-2222-222222222222/202102/08/005934.tar.gz |
+--------------------------------------+-------------------------------------------+---------------------+-------------------------------------------------------------------------------------+
```

---
**NOTE**

`cluster_id` is mocked, these clusters are not real.

---

### Content of `cluster_thanos_info` table

```
+--------------------------------------+---------------+--------------+-----------+---------------------+
| cluster_id                           | ebs_account   | email_domain | managed   | collected_at        |
|--------------------------------------+---------------+--------------+-----------+---------------------|
| 00000000-0000-0000-0000-000000000000 | 1234567       | foo.bar.com  | False     | 2021-02-08 01:00:00 |
| 11111111-1111-1111-1111-111111111111 | 2345678       | bar.cz       | False     | 2021-02-08 01:00:00 |
| 22222222-2222-2222-2222-222222222222 | 3456789       | xyzzy.org    | True      | 2021-02-08 01:00:00 |
| 33333333-3333-3333-3333-333333333333 | 4567890       | foo.bar.com  | False     | 2021-02-08 01:00:00 |
| 44444444-4444-4444-4444-444444444444 | 5678901       | bar.cz       | False     | 2021-02-08 01:00:00 |
| 55555555-5555-5555-5555-555555555555 | 6789012       | xyzzy.org    | False     | 2021-02-08 01:00:00 |
+--------------------------------------+---------------+--------------+-----------+---------------------+
```

---
**NOTE**

`cluster_id` is mocked, these clusters are not real.
`ebs_account` is mocked as well
`email_domain` is mocked too

---
