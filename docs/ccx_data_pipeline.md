# Data produced by OCP rules engine

That form of data is produced by `ccx_data_pipeline` service, which provides a
_publisher_ class that can send the generated reports to selected Kafka topic.
This class is named `ccx_data_pipeline.kafka_publisher.KafkaPublisher` and its
source code can be find in the service repository (see the link below this
paragraph). The report generated by the framework are enhanced with more
context information taken from different sources, like the organization ID,
unique cluster name, or the `LastChecked` timestamp (taken from the incoming
Kafka record containing the URL to the archive).

Other relevant information about `ccx_data_pipeline` can be found on address
[https://redhatinsights.github.io/ccx-data-pipeline/](https://redhatinsights.github.io/ccx-data-pipeline/).

## Required attributes

Data produces by `ccx_data_pipeline` is in JSON format with the following four
top level attributes:

* `OrgID` (positive integer with organization ID)
* `ClusterName` (string with UUID of cluster name)
* `Report` (nested JSON-like structure that contains results of executing rules)
* `LastChecked`: (timestamp with TZ info)

---
**NOTE**

All required attributes are described below, including `Report` structure.

---

## Optional attributes

All attributes are required, i.e. no optional attributes are expected nor
supported in the recent version of CCX data pipeline.

## Basic format

The JSON generated by `ccx_data_pipeline` service that is being produced into
Kafka topic has the following format:

```json
{
  "OrgID": 123456, // (int) - number that we get from b64_identity field
  "ClusterName": "aaaaaaaa-bbbb-cccc-dddd-000000000000", // (string) - cluster UUID  that we read from URL
  "Report": {...} // nested JSON structure that contains results of executing rules,
  "LastChecked": "2020-01-23T16:15:59.478901889Z" // (string) - time of the archive uploading in ISO 8601 format, gotten from "timestamp" field
}
```
---
**NOTE**

`ClusterName` uses its canonical textual representation: the 16 octets of a
UUID are represented as 32 hexadecimal (base-16) digits, displayed in five
groups separated by hyphens, in the form 8-4-4-4-12 for a total of 36
characters (32 hexadecimal characters and 4 hyphens)

---

---
**NOTE**

The `LastChecked` attribute is a timestamp containing the zone designator Z
(aka "Zulu time" or more informally "Greenwich Mean Time")

---

### Additional information about top level attributes used in messages

- `OrgID`: retrieved from the incoming JSON, codified inside the `b64_identity`
  value. It is extracted from `identity-internal-org_id` path of keys. Please look
  at the document [Incoming messages in `platform.upload.buckit`](platform_upload_buckit_messages.md)
  for more information about messages containing `OrgID` among other info.
- `ClusterName`: the cluster name is retrieved from the downloaded archive. When
  the download successes and the archive is extracted prior to its processing by
  the engine, the cluster ID is read from a file named `config/id`. Please look
  at the document [Raw data stored in S3 bucket](raw_data_S3_bucket.md) for more
  information about S3 objects containing `ClusterName` among other info.
- `Report`: is the JSON generated by the engine when the archive is processed.
  Its basic structure is mentioned below.
- `LastChecked`: this field is copied directly from the incoming Kafka record,
  as `timestamp` key.

## Format of `Report` node

`Report` node is represented as a JSON dictionary with following four required attributes:

* `system`: additional information about the cluster
* `reports`: list of rules that detect any problem on given cluster
* `skips`: list of rules that have been skip because not all required information was available on checked cluster
* `pass`: list of rules that passes all conditions (i.e. rules without any problem detected)
* `info`: list of rules that return info messages only 
* `fingerprints`: ?

### Minimal structure of `Report` node

`Report` node can contains attributes with empty values. Its minimal structure ca look like:

```json
{
    "Report": {
        "system": {
            "metadata": {},
            "hostname": null
        },
        "reports": [],
        "fingerprints": [],
        "skips": [],
        "info": [],
        "pass": []
    }
}
```

## Examples

### Empty report without any rule hits nor rule skips

The following message contains just empty report without any rule hits nor rule skips nodes:

```json
{
    "OrgID": 12345678,
    "ClusterName": "aaaaaaaa-bbbb-cccc-dddd-0123456789ab",
    "LastChecked": "2020-04-02T09:00:05.268294Z",
    "Report": {
        "system": {
            "metadata": {},
            "hostname": null
        },
        "reports": [],
        "fingerprints": [],
        "skips": [],
        "info": [],
        "pass": []
    }
}
```

### Report without any rule hits, but with two rule skips

The following message contains report with two rule skips but not any rule hits:

```json
{
    "OrgID": 12345678,
    "ClusterName": "aaaaaaaa-bbbb-cccc-dddd-0123456789ab",
    "LastChecked": "2020-04-02T09:00:05.268294Z",
    "Report": {
        "system": {
            "metadata": {},
            "hostname": null
        },
        "reports": [],
        "fingerprints": [],
        "skips": [
            {
                "rule_fqdn": "ccx_rules_ocp.ocs.check_ocs_version.report",
                "reason": "MISSING_REQUIREMENTS",
                "details": "All: ['ccx_ocp_core.specs.must_gather_ocs.OperatorsOcsMGOCS'] Any: ",
                "type": "skip"
            },
            {
                "rule_fqdn": "ccx_rules_ocp.ocs.check_pods_scc.report",
                "reason": "MISSING_REQUIREMENTS",
                "details": "All: ['ccx_ocp_core.specs.must_gather_ocs.PodsMGOCS'] Any: ",
                "type": "skip"
            }
        ],
        "info": [],
        "pass": []
    }
}
```

### Report with one hit - tutorial rule

A typical message for a node "hit" just by so-called tutorial rule.
Additionally two other rules was skipped:

```json
    "OrgID": 12345678,
    "ClusterName": "aaaaaaaa-bbbb-cccc-dddd-0123456789ab",
    "LastChecked": "2020-04-02T09:00:05.268294Z",
    "Report": {
        "system": {
            "metadata": {},
            "hostname": null
        },
        "reports": [
            {
                "rule_id": "tutorial_rule|TUTORIAL_ERROR",
                "component": "ccx_rules_ocp.external.tutorial_rule.report",
                "type": "rule",
                "key": "TUTORIAL_ERROR",
                "details": {
                    "type": "rule",
                    "error_key": "TUTORIAL_ERROR"
                },
                "tags": [],
                "links": {}
            }
        ],
        "fingerprints": [],
        "skips": [
            {
                "rule_fqdn": "ccx_rules_ocp.ocs.check_ocs_version.report",
                "reason": "MISSING_REQUIREMENTS",
                "details": "All: ['ccx_ocp_core.specs.must_gather_ocs.OperatorsOcsMGOCS'] Any: ",
                "type": "skip"
            },
            {
                "rule_fqdn": "ccx_rules_ocp.ocs.check_pods_scc.report",
                "reason": "MISSING_REQUIREMENTS",
                "details": "All: ['ccx_ocp_core.specs.must_gather_ocs.PodsMGOCS'] Any: ",
                "type": "skip"
            },
        ],
        "info": [],
        "pass": []
    }
}
```

### Report with one hit - not tutorial rule

A message returned for cluster with one real rule hit (it is not tutorial rule):

```json
{
    "OrgID": 12345678,
    "ClusterName": "aaaaaaaa-bbbb-cccc-dddd-0123456789ab",
    "LastChecked": "2020-04-02T09:00:05.268294Z",
    "Report": {
        "system": {
            "metadata": {},
            "hostname": null
        },
        "reports": [
            {
                "rule_id": "nodes_requirements_check|NODES_MINIMUM_REQUIREMENTS_NOT_MET",
                "component": "ccx_rules_ocp.external.rules.nodes_requirements_check.report",
                "type": "rule",
                "key": "NODES_MINIMUM_REQUIREMENTS_NOT_MET",
                "details": {
                    "nodes": [
                        {
                            "name": "foo1",
                            "role": "master",
                            "memory": 8.16,
                            "memory_req": 16
                        }
                    ],
                    "link": "https://docs.openshift.com/container-platform/4.1/installing/installing_bare_metal/installing-bare-metal.html#minimum-resource-requirements_installing-bare-metal",
                    "type": "rule",
                    "error_key": "NODES_MINIMUM_REQUIREMENTS_NOT_MET"
                },
                "tags": [],
                "links": {
                    "docs": [
                        "https://docs.openshift.com/container-platform/4.1/installing/installing_bare_metal/installing-bare-metal.html#minimum-resource-requirements_installing-bare-metal"
                    ]
                }
            }
        ],
        "fingerprints": [],
        "skips": [
            {
                "rule_fqdn": "ccx_rules_ocp.ocs.check_ocs_version.report",
                "reason": "MISSING_REQUIREMENTS",
                "details": "All: ['ccx_ocp_core.specs.must_gather_ocs.OperatorsOcsMGOCS'] Any: ",
                "type": "skip"
            }
        ],
        "info": [],
        "pass": []
    }
}
```
